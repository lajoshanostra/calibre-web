{% extends "layout.html" %}
{% block body %}
<div class="discover">
  <h1>{{title}}</h1>
  <form role="form" method="POST" autocomplete="off">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="col-md-10 col-lg-8">
    {% if new_user or ( current_user and content.name != "Guest" and current_user.role_admin() ) %}
    <div class="form-group required">
      <label for="name">{{_('Username')}}</label>
      <input type="text" class="form-control" name="name" id="name" value="{{ content.name if content.name != None }}" autocomplete="off">
    </div>
    {% endif %}
    <div class="form-group">
      <label for="email">{{_('Email')}}</label>
      <input type="email" class="form-control" name="email" id="email" value="{{ content.email if content.email != None }}" autocomplete="off">
    </div>
    {% if ( current_user and current_user.role_passwd() or current_user.role_admin() ) and not content.role_anonymous() %}
      {% if current_user and current_user.role_admin() and not new_user and not profile and ( mail_configured and content.email if content.email != None ) %}
        <a class="btn btn-default postAction" id="resend_password" role="button" data-action="{{url_for('admin.reset_user_password', user_id = content.id) }}">{{_('Reset user Password')}}</a>
      {% endif %}
        <div class="form-group">
          <label for="password">{{_('Password')}}</label>
          <input type="password" class="form-control" name="password" id="password" data-lang="{{ current_user.locale }}" data-verify="{{ config.config_password_policy }}" {% if config.config_password_policy %} data-min={{ config.config_password_min_length }} data-word={{ config.config_password_character }} data-special={{ config.config_password_special }} data-upper={{ config.config_password_upper }} data-lower={{ config.config_password_lower }} data-number={{ config.config_password_number }}{% endif %} value="" autocomplete="off">
        </div>
    {% endif %}
    <div class="form-group">
      <label for="kindle_mail">{{_('Send to eReader Email Address. Use comma to separate emails for multiple eReaders')}}</label>
      <input type="email" class="form-control" name="kindle_mail" id="kindle_mail" value="{{ content.kindle_mail if content.kindle_mail != None }}">
    </div>
    {% if not content.role_anonymous() %}
    <div class="form-group">
    <label for="locale">{{_('Language')}}</label>
        <select name="locale" id="locale" class="form-control">
            {%  for translation in translations %}
                <option value="{{translation}}" {% if translation|string == content.locale %}selected{% endif %}>{{ translation.display_name|capitalize }}</option>
            {% endfor %}
        </select>
    </div>
    {% endif %}

    <div class="form-group">
      <label for="default_language">{{_('Language of Books')}}</label>
        <select name="default_language" id="default_language" class="form-control">
            <option value="all" {% if content.default_language == "all" %}selected{% endif %}>{{ _('Show All') }}</option>
            {%  for language in languages %}
            <option value="{{ language.lang_code }}" {% if content.default_language == language.lang_code %}selected{% endif %}>{{ language.name }}</option>
            {% endfor %}
        </select>
    </div>
    {% if registered_oauth.keys()| length > 0 and not new_user and profile %}
      {% for id, name in registered_oauth.items() %}
    <div class="form-group">
      <label>{{ name }} {{_('OAuth Settings')}}</label>
        {% if id not in oauth_status %}
        <a href="{{ url_for('oauth.'+ name +'_login') }}" id="config_{{ id }}_oauth" class="btn btn-primary">{{_('Link')}}</a>
        {% else %}
        <a href="{{ url_for('oauth.'+ name +'_login_unlink') }}" id="config_{{ id }}_oauth" class="btn btn-primary">{{_('Unlink')}}</a>
        {% endif %}
      {% endfor %}
    </div>
    {% endif %}
    {% if kobo_support and not new_user %}
    <label>{{ _('Kobo Sync Token')}}</label>
    <div class="form-group col">
      <a class="btn btn-default" id="config_create_kobo_token" data-toggle="modal" data-target="#modal_kobo_token" data-remote="false" href="{{ url_for('kobo_auth.generate_auth_token', user_id=content.id) }}">{{_('Create/View')}}</a>
      <div class="btn btn-danger" id="config_delete_kobo_token" data-value="{{ content.id }}" data-remote="false" {% if not content.remote_auth_token.first() %} style="display: none;" {% endif %}>{{_('Delete')}}</div>
    </div>
    <div class="form-group col">
      <div class="btn btn-default" id="kobo_full_sync" data-value="{% if current_user.role_admin() %}{{ content.id }}{% else %}0{% endif %}" {% if not content.remote_auth_token.first() %} style="display: none;" {% endif %}>{{_('Force full kobo sync')}}</div>
    </div>
    {% endif %}
    <div class="col-sm-6">
    {% for element in sidebar %}
      {% if element['config_show'] %}
        <div class="form-group">
          <input type="checkbox" name="show_{{element['visibility']}}" id="show_{{element['visibility']}}" {% if content.check_visibility(element['visibility']) %}checked{% endif %}>
          <label for="show_{{element['visibility']}}">{{element['show_text']}}</label>
        </div>
      {% endif %}
    {% endfor %}
      <div class="form-group">
          <input type="checkbox" name="Show_detail_random" id="Show_detail_random" {% if content.show_detail_random() %}checked{% endif %}>
          <label for="Show_detail_random">{{_('Show Random Books in Detail View')}}</label>
      </div>
      {% if ( current_user and current_user.role_admin() and not new_user ) and not simple %}
      <a href="#" id="get_user_tags" class="btn btn-default" data-id="{{content.id}}" data-toggle="modal" data-target="#restrictModal">{{_('Add Allowed/Denied Tags')}}</a>
      <a href="#" id="get_user_column_values" data-id="{{content.id}}" class="btn btn-default" data-toggle="modal" data-target="#restrictModal">{{_('Add allowed/Denied Custom Column Values')}}</a>
      {% endif %}
    </div>
      <div class="col-sm-6">
    {% if current_user and current_user.role_admin() and not profile %}
    {% if not content.role_anonymous() %}
    <div class="form-group">
      <input type="checkbox" name="admin_role" id="admin_role" {% if content.role_admin() %}checked{% endif %}>
      <label for="admin_role">{{_('Admin User')}}</label>
    </div>
    {% endif %}
    <div class="form-group">
      <input type="checkbox" name="download_role" id="download_role" {% if content.role_download() %}checked{% endif %}>
      <label for="download_role">{{_('Allow Downloads')}}</label>
    </div>
    <div class="form-group">
      <input type="checkbox" name="viewer_role" id="viewer_role" {% if content.role_viewer() %}checked{% endif %}>
      <label for="viewer_role">{{_('Allow eBook Viewer')}}</label>
    </div>
    {% if config.config_uploading %}
    <div class="form-group">
      <input type="checkbox" name="upload_role" id="upload_role" {% if content.role_upload() %}checked{% endif %}>
      <label for="upload_role">{{_('Allow Uploads')}}</label>
    </div>
    {% endif %}
    <div class="form-group">
      <input type="checkbox" name="edit_role" data-control="edit_settings" id="edit_role" {% if content.role_edit() %}checked{% endif %}>
      <label for="edit_role">{{_('Allow Edit')}}</label>
    </div>
    <div data-related="edit_settings">
      <div class="form-group">
        <input type="checkbox" name="delete_role" id="delete_role" {% if content.role_delete_books() %}checked{% endif %}>
        <label for="delete_role">{{_('Allow Delete Books')}}</label>
      </div>
    </div>
    {% if not content.role_anonymous() %}
      <div class="form-group">
        <input type="checkbox" name="passwd_role" id="passwd_role" {% if content.role_passwd() %}checked{% endif %}>
        <label for="passwd_role">{{_('Allow Changing Password')}}</label>
      </div>
      <div class="form-group">
        <input type="checkbox" name="edit_shelf_role" id="edit_shelf_role" {% if content.role_edit_shelfs() %}checked{% endif %}>
        <label for="edit_shelf_role">{{_('Allow Editing Public Shelves')}}</label>
      </div>
    {% endif %}
  {% endif %}
    {% if kobo_support and not content.role_anonymous() and not simple%}
    <div class="form-group">
      <input type="checkbox" name="kobo_only_shelves_sync" id="kobo_only_shelves_sync" {% if content.kobo_only_shelves_sync %}checked{% endif %}>
      <label for="kobo_only_shelves_sync">{{_('Sync only books in selected shelves with Kobo')}}</label>
    </div>
    {% endif %}
    
    {% if config.config_moonreader_sync and not content.role_anonymous() and profile %}
    <div class="form-group">
      <h4>{{_('MoonReader Reading Position Sync via Google Drive')}}</h4>
      <div class="form-group">
        {% if user_gdrive_status.authenticated %}
          <div class="alert alert-success">
            <strong>{{_('Connected')}}</strong>: {{ user_gdrive_status.email }}
            <button type="button" class="btn btn-sm btn-danger pull-right" onclick="disconnectMoonreaderGdrive()">
              {{_('Disconnect')}}
            </button>
          </div>
          
          <div class="form-group">
            <label for="moonreader_folder_path">{{_('Moonreader Positions Folder')}}</label>
            <div class="input-group">
              <input type="text" class="form-control" id="moonreader_folder_path" 
                     value="{{ user_gdrive_status.folder_name if user_gdrive_status.folder_name else '/Apps/Books/.Moon+/Cache' }}" 
                     readonly>
              <span class="input-group-btn">
                <button type="button" class="btn btn-info" onclick="showFolderPicker()">
                  {{_('Browse')}}
                </button>
                <button type="button" class="btn btn-success" onclick="saveFolderPath()">
                  {{_('Save')}}
                </button>
              </span>
            </div>
            <small class="form-text text-muted">{{_('Google Drive path for Moonreader position files')}}</small>
          </div>
          
          <!-- Folder Picker Modal -->
          <div class="modal fade" id="folderPickerModal" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title">{{_('Select Google Drive Folder')}}</h4>
                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <!-- Breadcrumb navigation -->
                  <nav aria-label="breadcrumb">
                    <ol class="breadcrumb" id="folderBreadcrumb">
                      <li class="breadcrumb-item active">My Drive</li>
                    </ol>
                  </nav>
                  
                  <!-- Folder list -->
                  <div id="folderList">
                    <div class="text-center">
                      <i class="fa fa-spinner fa-spin"></i> {{_('Loading...')}}
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal">{{_('Cancel')}}</button>
                  <button type="button" class="btn btn-primary" onclick="selectCurrentFolder()">{{_('Select This Folder')}}</button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <button type="button" id="test_moonreader_connection" class="btn btn-info">
              {{_('Test Connection')}}
            </button>
          </div>
          
        {% else %}
          <div class="alert alert-info">
            <strong>{{_('Not Connected')}}</strong>
            {% if user_gdrive_status.error %}
              <br><small class="text-muted">{{ user_gdrive_status.error }}</small>
            {% endif %}
          </div>
          <div class="form-group">
            <a href="{{ url_for('web.moonreader_gdrive_auth') }}" class="btn btn-primary">
              {{_('Connect Google Drive')}}
            </a>
          </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
    </div>
    <div class="col-sm-12">
      <div id="user_submit" class="btn btn-default">{{_('Save')}}</div>
      {% if not profile %}
        <div class="btn btn-default" data-back="{{ url_for('admin.admin') }}" id="back">{{_('Cancel')}}</div>
      {% endif %}
      {% if current_user and current_user.role_admin() and not profile and not new_user and not content.role_anonymous() %}
        <div class="btn btn-danger" id="btndeluser" data-value="{{ content.id }}" data-remote="false" >{{_('Delete User')}}</div>
      {% endif %}
    </div>
    </div>
  </form>
</div>

<div class="modal fade" id="modal_kobo_token" tabindex="-1" role="dialog" aria-labelledby="kobo_tokenModalLabel">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="kobo_tokenModalLabel">{{_('Generate Kobo Auth URL')}}</h4>
      </div>
      <div class="modal-body">...</div>
      <div class="modal-footer">
        <button type="button" id="kobo_close" class="btn btn-default" data-dismiss="modal">{{_('Close')}}</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
{% block modal %}
{{ restrict_modal() }}
{{ delete_confirm_modal() }}
{% endblock %}
{% block js %}
<script src="{{ url_for('static', filename='js/libs/bootstrap-table/bootstrap-table.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/libs/bootstrap-table/bootstrap-table-editable.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/libs/bootstrap-table/bootstrap-editable.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/libs/pwstrength/i18next.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/libs/pwstrength/i18nextHttpBackend.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/libs/pwstrength/pwstrength-bootstrap.js') }}"></script>
<script src="{{ url_for('static', filename='js/password.js') }}"></script>
<script src="{{ url_for('static', filename='js/table.js') }}"></script>

{% if config.config_moonreader_sync and not content.role_anonymous() and profile %}
<script>
$(document).ready(function() {
    // Moonreader Google Drive functionality
    
    // Global variables for folder navigation
    var currentFolderPath = '/';
    var currentFolderId = 'root';
    var breadcrumbStack = [
        {id: 'root', name: 'My Drive', path: '/'}
    ];
    
    // Test connection button
    $('#test_moonreader_connection').click(function() {
        var button = $(this);
        var originalText = button.text();
        button.prop('disabled', true).text('Testing...');
        
        // Clear any existing messages
        button.siblings('.alert').remove();
        
        $.post('{{ url_for("web.test_gdrive_moonreader_connection") }}')
            .done(function(data) {
                var alertClass = data.status === 'success' ? 'alert-success' : 'alert-danger';
                var messageDiv = $('<div class="alert ' + alertClass + ' alert-dismissible" role="alert">' +
                    '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                    '<span aria-hidden="true">&times;</span></button>' +
                    data.message + '</div>');
                button.parent().append(messageDiv);
            })
            .fail(function() {
                var messageDiv = $('<div class="alert alert-danger alert-dismissible" role="alert">' +
                    '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                    '<span aria-hidden="true">&times;</span></button>' +
                    'Connection test failed</div>');
                button.parent().append(messageDiv);
            })
            .always(function() {
                button.prop('disabled', false).text(originalText);
            });
    });
});

// Folder picker functions
function showFolderPicker() {
    $('#folderPickerModal').modal('show');
    loadFolders('root');
    currentFolderPath = '/';
    currentFolderId = 'root';
    breadcrumbStack = [{id: 'root', name: 'My Drive', path: '/'}];
    updateBreadcrumb();
}

function loadFolders(parentId) {
    $('#folderList').html('<div class="text-center"><i class="fa fa-spinner fa-spin"></i> Loading...</div>');
    
    $.get('{{ url_for("web.get_moonreader_gdrive_folders") }}', {parent_id: parentId})
        .done(function(data) {
            if (data.error) {
                $('#folderList').html('<div class="alert alert-danger">' + data.error + '</div>');
                return;
            }
            
            var html = '';
            if (data.length === 0) {
                html = '<div class="text-muted">No folders found</div>';
            } else {
                data.forEach(function(folder) {
                    html += '<div class="folder-item" style="padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;" ' +
                            'onclick="openFolder(\'' + folder.id + '\', \'' + folder.title.replace(/'/g, "\\'") + '\')">' +
                            '<i class="fa fa-folder" style="margin-right: 8px; color: #f39c12;"></i>' +
                            folder.title + '</div>';
                });
            }
            $('#folderList').html(html);
        })
        .fail(function() {
            $('#folderList').html('<div class="alert alert-danger">Failed to load folders</div>');
        });
}

function openFolder(folderId, folderName) {
    // Add to breadcrumb stack
    var newPath = currentFolderPath === '/' ? '/' + folderName : currentFolderPath + '/' + folderName;
    breadcrumbStack.push({
        id: folderId,
        name: folderName,
        path: newPath
    });
    
    currentFolderId = folderId;
    currentFolderPath = newPath;
    
    updateBreadcrumb();
    loadFolders(folderId);
}

function navigateToBreadcrumb(index) {
    // Remove everything after this index
    breadcrumbStack = breadcrumbStack.slice(0, index + 1);
    
    var target = breadcrumbStack[index];
    currentFolderId = target.id;
    currentFolderPath = target.path;
    
    updateBreadcrumb();
    loadFolders(currentFolderId);
}

function updateBreadcrumb() {
    var breadcrumbHtml = '';
    breadcrumbStack.forEach(function(item, index) {
        if (index === breadcrumbStack.length - 1) {
            // Current folder - not clickable
            breadcrumbHtml += '<li class="breadcrumb-item active">' + item.name + '</li>';
        } else {
            // Previous folders - clickable
            breadcrumbHtml += '<li class="breadcrumb-item">' +
                '<a href="#" onclick="navigateToBreadcrumb(' + index + ')">' + item.name + '</a>' +
                '</li>';
        }
    });
    $('#folderBreadcrumb').html(breadcrumbHtml);
}

function selectCurrentFolder() {
    $('#moonreader_folder_path').val(currentFolderPath);
    $('#folderPickerModal').modal('hide');
}

function saveFolderPath() {
    var folderPath = $('#moonreader_folder_path').val().trim();
    if (!folderPath) {
        alert('Please select a folder path');
        return;
    }
    
    // Clear any existing messages
    $('#moonreader_folder_path').parent().parent().find('.alert').remove();
    
    $.post('{{ url_for("web.set_moonreader_gdrive_folder") }}', {
        folder_path: folderPath
    })
    .done(function(data) {
        var alertClass = data.status === 'success' ? 'alert-success' : 'alert-danger';
        var messageDiv = $('<div class="alert ' + alertClass + ' alert-dismissible" role="alert">' +
            '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
            '<span aria-hidden="true">&times;</span></button>' +
            data.message + '</div>');
             $('#moonreader_folder_path').parent().parent().append(messageDiv);
    })
    .fail(function() {
        var messageDiv = $('<div class="alert alert-danger alert-dismissible" role="alert">' +
            '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
            '<span aria-hidden="true">&times;</span></button>' +
            'Failed to save folder path</div>');
        $('#moonreader_folder_path').parent().parent().append(messageDiv);
    });
}

// Disconnect Moonreader Google Drive function (global scope)
function disconnectMoonreaderGdrive() {
    if (confirm('Are you sure you want to disconnect your Google Drive account for Moonreader sync?')) {
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("web.disconnect_moonreader_gdrive") }}';
        
        var csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = $('input[name="csrf_token"]').val();
        form.appendChild(csrfInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endif %}
{% endblock %}
